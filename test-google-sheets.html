<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets é€£ç·šæ¸¬è©¦</title>
    <style>
        body {
            font-family: 'Noto Sans TC', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .button {
            background-color: #4285f4;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .button:hover {
            background-color: #3367d6;
        }
        .button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.connected {
            background-color: #28a745;
            color: white;
        }
        .status.disconnected {
            background-color: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”— Google Sheets é€£ç·šæ¸¬è©¦</h1>
            <p>æ¸¬è©¦é–‹ç®±å·¥å…·ç³»çµ±èˆ‡ Google Sheets çš„é€£ç·šç‹€æ…‹</p>
            <div>
                <span class="status" id="connectionStatus">æœªé€£ç·š</span>
            </div>
        </div>

        <div class="test-section">
            <h3>1. åŸºæœ¬é€£ç·šæ¸¬è©¦</h3>
            <p>æ¸¬è©¦èˆ‡ Google Apps Script çš„åŸºæœ¬é€£ç·š</p>
            <button class="button" onclick="testBasicConnection()">æ¸¬è©¦åŸºæœ¬é€£ç·š</button>
            <div id="basicConnectionResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>2. å“¡å·¥è³‡æ–™æŸ¥è©¢æ¸¬è©¦</h3>
            <p>æ¸¬è©¦å¾ Google Sheets æŸ¥è©¢å“¡å·¥è³‡æ–™</p>
            <button class="button" onclick="testEmployeeQuery()">æ¸¬è©¦å“¡å·¥æŸ¥è©¢</button>
            <div id="employeeQueryResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>3. æ¡è³¼å–®æŸ¥è©¢æ¸¬è©¦</h3>
            <p>æ¸¬è©¦å¾ Google Sheets æŸ¥è©¢æ¡è³¼å–®è³‡æ–™</p>
            <input type="text" id="poNumberInput" placeholder="è¼¸å…¥æ¡è³¼å–®è™Ÿ (ä¾‹å¦‚: PO20240801)" style="padding: 8px; margin: 10px 0; width: 300px;">
            <br>
            <button class="button" onclick="testPOQuery()">æ¸¬è©¦æ¡è³¼å–®æŸ¥è©¢</button>
            <div id="poQueryResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>4. è³‡æ–™ä¸Šå‚³æ¸¬è©¦</h3>
            <p>æ¸¬è©¦ä¸Šå‚³åˆ°è²¨ç¢ºèªè³‡æ–™åˆ° Google Sheets</p>
            <button class="button" onclick="testDataUpload()">æ¸¬è©¦è³‡æ–™ä¸Šå‚³</button>
            <div id="dataUploadResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>5. å®Œæ•´åŠŸèƒ½æ¸¬è©¦</h3>
            <p>åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦é …ç›®</p>
            <button class="button" onclick="runAllTests()">åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦</button>
            <div id="allTestsResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script src="google-sheets-client.js"></script>
    <script>
        let sheetsManager = null;

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('load', async function() {
            console.log('é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ– Google Sheets ç®¡ç†å™¨...');
            await initializeManager();
        });

        // åˆå§‹åŒ– Google Sheets ç®¡ç†å™¨
        async function initializeManager() {
            try {
                sheetsManager = new GoogleSheetsManager(GOOGLE_APPS_SCRIPT_URL);
                const initialized = await sheetsManager.initialize();
                
                if (initialized) {
                    updateConnectionStatus(true);
                    console.log('Google Sheets ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ');
                } else {
                    updateConnectionStatus(false);
                    console.log('Google Sheets ç®¡ç†å™¨åˆå§‹åŒ–å¤±æ•—');
                }
            } catch (error) {
                updateConnectionStatus(false);
                console.error('åˆå§‹åŒ–æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š', error);
            }
        }

        // æ›´æ–°é€£ç·šç‹€æ…‹
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.textContent = 'å·²é€£ç·š';
                statusElement.className = 'status connected';
            } else {
                statusElement.textContent = 'æœªé€£ç·š';
                statusElement.className = 'status disconnected';
            }
        }

        // æ¸¬è©¦åŸºæœ¬é€£ç·š
        async function testBasicConnection() {
            const resultDiv = document.getElementById('basicConnectionResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'æ¸¬è©¦ä¸­...';

            try {
                if (!sheetsManager) {
                    throw new Error('Google Sheets ç®¡ç†å™¨å°šæœªåˆå§‹åŒ–');
                }

                const testResult = await sheetsManager.testConnection();
                
                if (testResult.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… é€£ç·šæˆåŠŸï¼\n\nå›æ‡‰è¨Šæ¯: ${testResult.message}\næ™‚é–“: ${new Date().toLocaleString()}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ é€£ç·šå¤±æ•—ï¼\n\néŒ¯èª¤é¡å‹: ${testResult.error}\néŒ¯èª¤è¨Šæ¯: ${testResult.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ æ¸¬è©¦æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼\n\néŒ¯èª¤è¨Šæ¯: ${error.message}`;
                }
        }

        // æ¸¬è©¦å“¡å·¥æŸ¥è©¢
        async function testEmployeeQuery() {
            const resultDiv = document.getElementById('employeeQueryResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'æŸ¥è©¢ä¸­...';

            try {
                if (!sheetsManager) {
                    throw new Error('Google Sheets ç®¡ç†å™¨å°šæœªåˆå§‹åŒ–');
                }

                const employees = await sheetsManager.getAllEmployees();
                
                if (employees.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… å“¡å·¥æŸ¥è©¢æˆåŠŸï¼\n\næ‰¾åˆ° ${employees.count} åå“¡å·¥\n\nå“¡å·¥åˆ—è¡¨:\n${JSON.stringify(employees.data, null, 2)}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ å“¡å·¥æŸ¥è©¢å¤±æ•—ï¼\n\néŒ¯èª¤é¡å‹: ${employees.error}\néŒ¯èª¤è¨Šæ¯: ${employees.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ æŸ¥è©¢æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼\n\néŒ¯èª¤è¨Šæ¯: ${error.message}`;
            }
        }

        // æ¸¬è©¦æ¡è³¼å–®æŸ¥è©¢
        async function testPOQuery() {
            const poNumber = document.getElementById('poNumberInput').value.trim();
            if (!poNumber) {
                alert('è«‹è¼¸å…¥æ¡è³¼å–®è™Ÿ');
                return;
            }

            const resultDiv = document.getElementById('poQueryResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = `æŸ¥è©¢æ¡è³¼å–® ${poNumber} ä¸­...`;

            try {
                if (!sheetsManager) {
                    throw new Error('Google Sheets ç®¡ç†å™¨å°šæœªåˆå§‹åŒ–');
                }

                const poResult = await sheetsManager.queryPurchaseOrder(poNumber);
                
                if (poResult.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… æ¡è³¼å–®æŸ¥è©¢æˆåŠŸï¼\n\næ¡è³¼å–®è™Ÿ: ${poResult.data.poNumber}\næ¡è³¼æ—¥æœŸ: ${poResult.data.purchaseDate}\nä¾›æ‡‰å•†: ${ä¾›æ‡‰å•†}\né€²è²¨ç¸½æ•¸: ${poResult.data.totalQuantity}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ æ¡è³¼å–®æŸ¥è©¢å¤±æ•—ï¼\n\néŒ¯èª¤é¡å‹: ${poResult.error}\néŒ¯èª¤è¨Šæ¯: ${poResult.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ æŸ¥è©¢æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼\n\néŒ¯èª¤è¨Šæ¯: ${error.message}`;
            }
        }

        // æ¸¬è©¦è³‡æ–™ä¸Šå‚³
        async function testDataUpload() {
            const resultDiv = document.getElementById('dataUploadResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'æ¸¬è©¦è³‡æ–™ä¸Šå‚³ä¸­...';

            try {
                if (!sheetsManager) {
                    throw new Error('Google Sheets ç®¡ç†å™¨å°šæœªåˆå§‹åŒ–');
                }

                // æ¸¬è©¦è³‡æ–™
                const testData = {
                    poNumber: 'PO20240801',
                    employeeName: 'æ¸¬è©¦å“¡å·¥',
                    productCategory: 'é›»å­ç”¢å“',
                    productName: 'æ¸¬è©¦å•†å“',
                    serialNumber: 'TEST' + Date.now(), // ä½¿ç”¨æ™‚é–“æˆ³é¿å…é‡è¤‡
                    quantity: 1,
                    notes: 'é€™æ˜¯ä¸€å€‹æ¸¬è©¦è¨˜éŒ„'
                };

                const uploadResult = await sheetsManager.uploadReceivingConfirm(testData);
                
                if (uploadResult.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… è³‡æ–™ä¸Šå‚³æˆåŠŸï¼\n\næ‰¹è™Ÿ: ${uploadResult.batchNumber}\næ™‚é–“æˆ³: ${uploadResult.timestamp}\n\nä¸Šå‚³çš„è³‡æ–™:\n${JSON.stringify(testData, null, 2)}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ è³‡æ–™ä¸Šå‚³å¤±æ•—ï¼\n\néŒ¯èª¤é¡å‹: ${uploadResult.error}\néŒ¯èª¤è¨Šæ¯: ${uploadResult.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ä¸Šå‚³æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼\n\néŒ¯èª¤è¨Šæ¯: ${error.message}`;
            }
        }

        // åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
        async function runAllTests() {
            const resultDiv = document.getElementById('allTestsResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'é–‹å§‹åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦...\n\n';

            try {
                // æ¸¬è©¦ 1: åŸºæœ¬é€£ç·š
                resultDiv.textContent += '1. æ¸¬è©¦åŸºæœ¬é€£ç·š...\n';
                const connectionTest = await sheetsManager.testConnection();
                resultDiv.textContent += connectionTest.success ? 'âœ… æˆåŠŸ\n' : 'âŒ å¤±æ•—\n';

                // æ¸¬è©¦ 2: å“¡å·¥æŸ¥è©¢
                resultDiv.textContent += '\n2. æ¸¬è©¦å“¡å·¥æŸ¥è©¢...\n';
                const employeeTest = await sheetsManager.getAllEmployees();
                resultDiv.textContent += employeeTest.success ? 'âœ… æˆåŠŸ\n' : 'âŒ å¤±æ•—\n';

                // æ¸¬è©¦ 3: æ¡è³¼å–®æŸ¥è©¢
                resultDiv.textContent += '\n3. æ¸¬è©¦æ¡è³¼å–®æŸ¥è©¢...\n';
                const poTest = await sheetsManager.queryPurchaseOrder('PO20240801');
                resultDiv.textContent += poTest.success ? 'âœ… æˆåŠŸ\n' : 'âŒ å¤±æ•—\n';

                // æ¸¬è©¦ 4: è³‡æ–™ä¸Šå‚³
                resultDiv.textContent += '\n4. æ¸¬è©¦è³‡æ–™ä¸Šå‚³...\n';
                const testData = {
                    poNumber: 'PO20240801',
                    employeeName: 'æ¸¬è©¦å“¡å·¥',
                    productCategory: 'é›»å­ç”¢å“',
                    productName: 'æ¸¬è©¦å•†å“',
                    serialNumber: 'TEST' + Date.now(),
                    quantity: 1,
                    notes: 'å®Œæ•´æ¸¬è©¦è¨˜éŒ„'
                };
                const uploadTest = await sheetsManager.uploadReceivingConfirm(testData);
                resultDiv.textContent += uploadTest.success ? 'âœ… æˆåŠŸ\n' : 'âŒ å¤±æ•—\n';

                resultDiv.textContent += '\nğŸ‰ æ‰€æœ‰æ¸¬è©¦å®Œæˆï¼';
                resultDiv.className = 'result success';

            } catch (error) {
                resultDiv.textContent += `\nâŒ åŸ·è¡Œæ¸¬è©¦æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}`;
                resultDiv.className = 'result error';
            }
        }
    </script>
</body>
</html>
